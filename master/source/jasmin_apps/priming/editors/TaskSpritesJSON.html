<html>
    <head>
        <link rel="stylesheet" type="text/css" href="jsoneditor/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="jsoneditor/bootstrap-theme.min.css" />
        <script type="text/javascript" src="../../../jasmin_ext/jquery.js"></script>        
        <script type="text/javascript" src="../jasmin.min.js"></script>
        <script src="jsoneditor/bootstrap.min.js"></script>
        <script src="jsoneditor/jsoneditor.min.js"></script>
<script>
// Set default theme
JSONEditor.defaults.options.theme = 'bootstrap3';

fail    = function(         message ) { console.log( "FAILED: "    + message ); };
report  = function( source, message ) { console.log( source + ": " + message ); };    
     
// Get data
window.onload = function() { 
    // Load JSON
    io     = new jasmin.RequestManager( fail, report, report );
    loader = new jasmin.Loader( io );
    loader.load( 
        {
            "Sprite"      : [ "json", "schemas/Sprite.json" ],
            "TaskSprites" : [ "json", "TaskSprites.json" ]
        },
        loaded
    );
};

// Use sprites to setup schema
spritesToSchema = function( sprites, schemaSprite ) {
    var schema = {};
    var propertyTypes = [ "attr", "css", "scale" ];
    var key, propertyType, property, i;
    for( key in sprites ) {
        // Deep copy Sprite Definition
        schema[ key ] = JSON.parse( JSON.stringify( schemaSprite ) );;
        // Copy properties
        for( i = 0; i < propertyTypes.length; i++ ) {
            // Copy array properties
            propertyType = propertyTypes[i];
            for( property in sprites[ key ][ propertyType ] ) {
                schema[ key ][ "properties" ][ propertyType ][ "properties" ][ property ] = { "type" : "string" };
            }
            // Copy recursive definition of children, if any
            if( sprites[ key ][ "children" ] !== undefined ) {
                schema[ key ][ "properties" ][ "children" ] = { "type" : "object" };
                
                schema[ key ][ "properties" ][ "children" ][ "properties" ] = spritesToSchema(
                    sprites[ key ][ "children" ],
                    schemaSprite
                );
            }
        }
    }    
    return schema;
};

loaded = function( reply ) {
    var schemaSprite = reply[ "Sprite" ];
    var sprites = reply[ "TaskSprites" ];

    // Setup schema
    var schema = {
        "title": "Sprites",
        "type" : "object",
        "format" : "grid"
    };
    
    // Fill schema with Sprites
    schema[ "properties" ] = spritesToSchema( sprites, schemaSprite );
    schema[ "default"]     = sprites;

    
    var editor = new JSONEditor(
        document.getElementById("editor_holder"),
        {
            schema: schema,
            ajax: true,
            disable_array_reorder: true,
            disable_properties: true
            //disable_collapse: true
        }
    );
};

startCanvas = function()
{
    var config = editor.getValue();
    window.location = "runCanvas.html?sprites=" +  encodeURIComponent( JSON.stringify( config ) );
};

</script>
<script type="text/javascript" src="../../trunk/www/static/js/plugins/jquery.js"></script>
    </head>
    <body>
        <button id="submit" onclick="startCanvas();" style="background-color:#CCCCFF;">Start Canvas</button>
        <div id="editor_holder"></div>
    </body>
</html>

